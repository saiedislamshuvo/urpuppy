x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: "50m"
    max-file: 6

x-base: &base
  depends_on:
    pgsql:
      condition: service_healthy
    redis:
      condition: service_healthy
    minio:
      condition: service_healthy

  image: ghcr.io/adichannnnnhere64/urpuppyv2:staging
  user: "${HOST_UID:-1000}:${HOST_GID:-1000}"

  ulimits:
    nofile:
      soft: 20000
      hard: 40000
  security_opt:
    - no-new-privileges:true
  logging: *default-logging
  restart: always

services:
  app:
    <<: *base
    healthcheck:
      test: [ "CMD", "curl", "--fail", "localhost:8000/up" ]
      interval: 3s
      retries: 12
      timeout: 5s
    networks:
      - web
      - urpuppy_internal
    env_file:
      - path: .env
    volumes:
      - '$DOCKER_DATA/staging-urpuppy/app/storage/app/public:/var/www/html/storage/app/public'
      - '$DOCKER_DATA/staging-urpuppy/app/storage/logs:/var/www/html/storage/logs'
    labels:
      traefik.enable: "true"
      traefik.docker.network: traefik_web
      traefik.http.routers.app.rule: "Host(`${URPUPPY_APP_HOST}`)"
      traefik.http.routers.app.entryPoints: "app"
      traefik.http.routers.app.service: "app-service"
      traefik.http.routers.app.middlewares: "redirect-scheme,app-retry,app-compress,security-headers,html-cache"

      traefik.http.middlewares.html-cache.headers.customResponseHeaders.Cache-Control: "public, max-age=7600"

      # Static assets cache middleware (for Vite or similar)
      traefik.http.middlewares.static-assets-cache.headers.customResponseHeaders.Cache-Control: "public, max-age=31536000, immutable"

      # Static assets router (e.g., Vite build assets)
      traefik.http.routers.static-assets.rule: "Host(`${URPUPPY_APP_HOST}`) && PathPrefix(`/build/assets/`)"
      traefik.http.routers.static-assets.service: "app-service"
      traefik.http.routers.static-assets.middlewares: "app-compress,static-assets-cache"

      # Image cache middleware
      traefik.http.middlewares.image-cache.headers.customResponseHeaders.Cache-Control: "public, max-age=31536000, immutable"

      # Image router using PathRegexp for individual webp files and folders
      traefik.http.routers.images.rule: "Host(`${URPUPPY_APP_HOST}`) && PathRegexp(`^/(images|img|storage/fonts)/.*|/desktop.*\\.webp|/mobile\\.webp`)"
      traefik.http.routers.images.service: "app-service"
      traefik.http.routers.images.middlewares: "app-compress,image-cache"

      traefik.http.routers.app-secure.rule: "Host(`${URPUPPY_APP_HOST}`)"
      traefik.http.routers.app-secure.entryPoints: "app-secure"
      traefik.http.routers.app-secure.service: "app-service"
      traefik.http.routers.app-secure.tls: "true"
      traefik.http.routers.app-secure.tls.certresolver: "myresolver"

      traefik.http.routers.app-secure.middlewares: "redirect-scheme,app-retry,app-compress,security-headers"

      traefik.http.services.app-service.loadbalancer.server.port: "8000"
      traefik.http.services.app-service.loadbalancer.healthCheck.path: "/up"
      traefik.http.services.app-service.loadbalancer.healthCheck.hostname: "localhost"
      traefik.http.services.app-service.loadbalancer.healthCheck.port: "8000"
      traefik.http.services.app-service.loadbalancer.healthCheck.interval: "3s"
      traefik.http.services.app-service.loadbalancer.healthCheck.timeout: "5s"

      traefik.http.middlewares.limit.buffering.maxRequestBodyBytes: "460000000"
      traefik.http.middlewares.redirect-scheme.redirectscheme.scheme: "https"
      traefik.http.middlewares.redirect-scheme.redirectscheme.permanent: "true"
      traefik.http.middlewares.app-retry.retry.attempts: "4"
      traefik.http.middlewares.app-retry.retry.initialinterval: "100ms"
      traefik.http.middlewares.app-compress.compress: "true"
      traefik.http.middlewares.security-headers.headers.accesscontrolmaxage: "100"
      traefik.http.middlewares.security-headers.headers.addvaryheader: "true"
      traefik.http.middlewares.security-headers.headers.hostsproxyheaders: "X-Forwarded-Host"
      traefik.http.middlewares.security-headers.headers.stsseconds: "63072000"
      traefik.http.middlewares.security-headers.headers.stsincludesubdomains: "true"
      traefik.http.middlewares.security-headers.headers.stspreload: "true"
      traefik.http.middlewares.security-headers.headers.forcestsheader: "true"
      traefik.http.middlewares.security-headers.headers.customFrameOptionsValue: "SAMEORIGIN"
      traefik.http.middlewares.security-headers.headers.contenttypenosniff: "true"
      traefik.http.middlewares.security-headers.headers.browserxssfilter: "true"
      traefik.http.middlewares.security-headers.headers.referrerpolicy: "no-referrer-when-downgrade"
      traefik.http.middlewares.security-headers.headers.permissionspolicy: "camera=(), geolocation=(), microphone=(), payment=(), usb=(), interest-cohort=(), gyroscope=()"

  horizon:
    <<: *base
    environment:
      CONTAINER_MODE: horizon
    networks:
      - urpuppy_internal

    labels:
      traefik.enable: "false"
    volumes:
      - '$DOCKER_DATA/staging-urpuppy/app-queue/storage/app/public:/var/www/html/storage/app/public'
      - '$DOCKER_DATA/staging-urpuppy/app-queue/storage/logs:/var/www/html/storage/logs'

  scheduler:
    <<: *base
    environment:
      CONTAINER_MODE: scheduler
    networks:
      - urpuppy_internal

    volumes:
      - '$DOCKER_DATA/staging-urpuppy/app-scheduler/storage/app/public:/var/www/html/storage/app/public'
      - '$DOCKER_DATA/staging-urpuppy/app-scheduler/storage/logs:/var/www/html/storage/logs'
    labels:
      traefik.enable: "false"
    
  redis:
    image: 'redis:alpine'
    networks:
      - urpuppy_internal

    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD}", "--maxmemory", "2gb" ]
    security_opt:
      - no-new-privileges:true
    volumes:
      - $DOCKER_DATA/staging-urpuppy/redis:/data
    logging: *default-logging
    healthcheck:
      test: [ "CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping" ]
      retries: 3
      timeout: 5s
      interval: 5s
    restart: always
    labels:
      traefik.enable: "false"

  pgsql:
    image: 'postgres:17-bookworm'
    networks:
      - urpuppy_internal

    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    security_opt:
      - no-new-privileges:true
    environment:
      PGPASSWORD: '${DB_PASSWORD}'
      POSTGRES_DB: '${DB_DATABASE}'
      POSTGRES_USER: '${DB_USERNAME}'
      POSTGRES_PASSWORD: '${DB_PASSWORD}'
      POSTGRES_HOST_AUTH_METHOD: 'md5'
      POSTGRES_INITDB_ARGS: '--auth-host=md5'
    volumes:
      - urpuppy-staging-pgsql:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "${DB_DATABASE}", "-U", "${DB_USERNAME}"]
      interval: 15s
      retries: 12
      timeout: 20s
    restart: always
    logging: *default-logging
    labels:
      traefik.enable: "false"
      docker-volume-backup.stop-during-backup: "true"
      docker-volume-backup.archive-pre: "/bin/sh -c 'pg_dump -U ${DB_USERNAME} -F t ${DB_DATABASE} > /backup/${DB_DATABASE}-database.tar'"

  backup:
    image: offen/docker-volume-backup:v2
    networks:
      - urpuppy_internal

    security_opt:
      - no-new-privileges:true
    environment:
      BACKUP_FILENAME: backup-%Y-%m-%dT%H-%M-%S.tar.gz
      BACKUP_PRUNING_PREFIX: backup-
      BACKUP_CRON_EXPRESSION: "0 2 * * *"
      BACKUP_RETENTION_DAYS: '7'
    restart: always
    depends_on:
      pgsql:
        condition: service_healthy
    logging: *default-logging
    volumes:
      - $DOCKER_DATA/staging-urpuppy/pgsql:/backup/pgsql:ro
      - $DOCKER_DATA/staging-urpuppy/backup/volumes:/archive
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    labels:
      traefik.enable: "false"

  minio:
    image: 'minio/minio:latest'
    security_opt:
      - no-new-privileges:true
    networks:
      - web
      - urpuppy_internal

    environment:
      MINIO_ROOT_USER: '${MINIO_ROOT_USER}'
      MINIO_ROOT_PASSWORD: '${MINIO_ROOT_PASSWORD}'
    volumes:
      - $DOCKER_DATA/staging-urpuppy/s3:/data/minio
    command: 'minio server /data/minio --console-address ":8900"'
    restart: always
    logging: *default-logging
    labels:
      traefik.enable: "true"

      traefik.http.routers.minio-console.entryPoints: "minio-console"
      traefik.http.routers.minio-console.service: "minio-console-service"
      traefik.http.routers.minio-console.middlewares: "minio-auth,minio-retry"
      traefik.http.services.minio-console-service.loadbalancer.server.port: "8900"

      traefik.http.routers.minio.rule: "Host(`${URPUPPY_APP_HOST}`)"
      traefik.http.routers.minio.entryPoints: "minio"
      traefik.http.routers.minio.service: "minio-service"
      traefik.http.routers.minio.middlewares: "minio-retry,minio-compress"
      traefik.http.services.minio-service.loadbalancer.server.port: "9000"

      traefik.http.middlewares.minio-compress.compress: "true"
      traefik.http.middlewares.minio-retry.retry.attempts: "4"
      traefik.http.middlewares.minio-retry.retry.initialinterval: "100ms"
      traefik.http.middlewares.minio-auth.basicauth.removeheader: "true"
      traefik.http.middlewares.minio-auth.basicauth.users: "${MINIO_AUTH_USERS:-user:$$2y$$05$$8zbpsdxg9wDiiKdqxiB0zeAlxZtG68P1SDBOvCN4IooLFewLx70Gm}"
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      retries: 3
      timeout: 5s
      interval: 10s

networks:
  web:
    name: traefik_web
    external: true
  urpuppy_internal:
    external: false

volumes:
  urpuppy-staging-pgsql:
    driver: local
  mariadb_data3:
    driver: local